{% extends "admin/base.html" %}

{% block title %}Database Statistics - Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1>üìä Database Statistics & Data Retention</h1>
        <p class="subtitle">Monitor your data storage and 90-day retention policy</p>
    </div>

    <!-- Status Alert -->
    <div class="status-card" id="status-card">
        <div class="status-icon">‚úì</div>
        <div class="status-content">
            <h3>Data Retention Status</h3>
            <p id="status-message">90-day automatic deletion enabled - Database optimized</p>
            <p class="status-time" id="status-time">Last check: Just now</p>
        </div>
    </div>

    <!-- Database Statistics Grid -->
    <div class="stats-grid">
        <!-- Storage Used -->
        <div class="stat-card">
            <div class="stat-icon">üíæ</div>
            <div class="stat-content">
                <h4>Database Size</h4>
                <div class="stat-value" id="db-size">--</div>
                <p class="stat-subtext">Current storage used</p>
            </div>
        </div>

        <!-- Orders Count -->
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <h4>Total Orders</h4>
                <div class="stat-value" id="orders-count">--</div>
                <p class="stat-subtext">In last 90 days</p>
            </div>
        </div>

        <!-- Payments Count -->
        <div class="stat-card">
            <div class="stat-icon">üí≥</div>
            <div class="stat-content">
                <h4>Total Payments</h4>
                <div class="stat-value" id="payments-count">--</div>
                <p class="stat-subtext">In last 90 days</p>
            </div>
        </div>

        <!-- Data Range -->
        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-content">
                <h4>Data Range</h4>
                <div class="stat-value" id="data-range">--</div>
                <p class="stat-subtext">Oldest to newest order</p>
            </div>
        </div>
    </div>

    <!-- Retention Policy Info -->
    <div class="info-section">
        <h2>90-Day Retention Policy</h2>
        <div class="info-content">
            <div class="info-box">
                <h3>How It Works</h3>
                <ul>
                    <li><strong>Automatic Deletion:</strong> Runs daily at 2:00 AM</li>
                    <li><strong>Data Retention:</strong> Last 90 days always kept</li>
                    <li><strong>Space Optimization:</strong> Database automatically compressed</li>
                    <li><strong>Cost Impact:</strong> Fits within Google Cloud free tier (10 GB)</li>
                </ul>
            </div>

            <div class="info-box highlight">
                <h3>Cost Savings</h3>
                <ul>
                    <li><strong>Year 1:</strong> Save $200-350</li>
                    <li><strong>Yearly Ongoing:</strong> Save $4,200+</li>
                    <li><strong>Forever Cost:</strong> $0/month for storage</li>
                    <li><strong>Per Hotel:</strong> Less than $1/month</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- What Gets Deleted & Kept -->
    <div class="info-section">
        <h2>What Gets Deleted vs Kept</h2>
        <div class="deletion-grid">
            <div class="deletion-box delete-box">
                <h3>‚ùå Deleted After 90 Days</h3>
                <ul>
                    <li>Old order records</li>
                    <li>Order items & details</li>
                    <li>Historical payment logs</li>
                    <li>Order status changes</li>
                    <li>Old subscription logs</li>
                </ul>
            </div>

            <div class="deletion-box keep-box">
                <h3>‚úÖ Kept Permanently</h3>
                <ul>
                    <li>Current subscriptions</li>
                    <li>Hotel settings</li>
                    <li>User accounts</li>
                    <li>Financial summaries</li>
                    <li>Active payment methods</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Manual Cleanup Section -->
    <div class="control-section">
        <h2>Manual Data Cleanup</h2>
        <p class="control-description">
            While automatic cleanup runs daily at 2:00 AM, you can manually trigger cleanup anytime:
        </p>

        <div class="control-buttons">
            <button class="btn btn-primary" onclick="triggerCleanup()">
                üßπ Clean Old Data Now
            </button>
            <button class="btn btn-secondary" onclick="refreshStats()">
                üîÑ Refresh Statistics
            </button>
        </div>

        <div id="cleanup-result" class="cleanup-result" style="display:none;"></div>
    </div>

    <!-- Detailed Information -->
    <div class="info-section">
        <h2>Detailed Information</h2>
        <div class="details-table">
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Database Size</td>
                        <td id="detail-db-size">--</td>
                        <td id="detail-db-status">--</td>
                    </tr>
                    <tr>
                        <td>Free Tier Limit</td>
                        <td>10 GB</td>
                        <td>‚úÖ Available</td>
                    </tr>
                    <tr>
                        <td>Current Usage %</td>
                        <td id="detail-usage-percent">--</td>
                        <td id="detail-usage-status">--</td>
                    </tr>
                    <tr>
                        <td>Retention Period</td>
                        <td>90 days</td>
                        <td>‚úÖ Active</td>
                    </tr>
                    <tr>
                        <td>Oldest Data</td>
                        <td id="detail-oldest">--</td>
                        <td>üìÖ</td>
                    </tr>
                    <tr>
                        <td>Newest Data</td>
                        <td id="detail-newest">--</td>
                        <td>üìÖ</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Schedule Information -->
    <div class="info-section">
        <h2>‚è∞ Automatic Deletion Schedule</h2>
        <div class="schedule-box">
            <p><strong>Daily Cleanup Time:</strong> 2:00 AM</p>
            <p><strong>Frequency:</strong> Every 24 hours</p>
            <p><strong>Retention Period:</strong> 90 days</p>
            <p><strong>Next Run:</strong> <span id="next-cleanup-time">Today at 2:00 AM</span></p>
            <p><strong>Status:</strong> <span class="status-badge">üü¢ Active</span></p>
        </div>
    </div>
</div>

<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-header h1 {
        color: #2c3e50;
        font-size: 2em;
        margin: 0;
    }

    .subtitle {
        color: #7f8c8d;
        margin-top: 5px;
    }

    /* Status Card */
    .status-card {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .status-icon {
        font-size: 3em;
        margin-right: 20px;
        min-width: 50px;
    }

    .status-content h3 {
        margin: 0 0 5px 0;
        font-size: 1.3em;
    }

    .status-content p {
        margin: 3px 0;
        opacity: 0.95;
    }

    .status-time {
        font-size: 0.9em;
        opacity: 0.8;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white;
        border: 1px solid #ecf0f1;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        gap: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stat-icon {
        font-size: 2.5em;
        min-width: 60px;
        text-align: center;
    }

    .stat-content h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #27ae60;
    }

    .stat-subtext {
        margin: 5px 0 0 0;
        color: #7f8c8d;
        font-size: 0.9em;
    }

    /* Info Section */
    .info-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 4px solid #3498db;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .info-section h2 {
        color: #2c3e50;
        margin-top: 0;
        margin-bottom: 20px;
    }

    .info-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .info-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 3px solid #3498db;
    }

    .info-box.highlight {
        background: #f0f8ff;
        border-left-color: #27ae60;
    }

    .info-box h3 {
        margin-top: 0;
        color: #2c3e50;
    }

    .info-box ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .info-box li {
        padding: 8px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .info-box li:last-child {
        border-bottom: none;
    }

    /* Deletion Grid */
    .deletion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .deletion-box {
        padding: 20px;
        border-radius: 6px;
        border-left: 4px solid;
    }

    .delete-box {
        background: #ffe8e8;
        border-left-color: #e74c3c;
    }

    .keep-box {
        background: #e8f5e9;
        border-left-color: #27ae60;
    }

    .deletion-box h3 {
        margin-top: 0;
        font-size: 1.1em;
    }

    .deletion-box ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .deletion-box li {
        padding: 8px 0;
    }

    /* Control Section */
    .control-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px dashed #3498db;
    }

    .control-section h2 {
        color: #2c3e50;
        margin-top: 0;
    }

    .control-description {
        color: #555;
        margin-bottom: 20px;
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95em;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
    }

    .cleanup-result {
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
    }

    .cleanup-result.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .cleanup-result.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Details Table */
    .details-table {
        margin-top: 20px;
    }

    .details-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .details-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        color: #2c3e50;
    }

    .details-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }

    .details-table tr:hover {
        background: #f8f9fa;
    }

    /* Schedule Box */
    .schedule-box {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 6px;
        border-left: 4px solid #3498db;
    }

    .schedule-box p {
        margin: 10px 0;
        color: #2c3e50;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        background: #d4edda;
        color: #155724;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .info-content {
            grid-template-columns: 1fr;
        }

        .deletion-grid {
            grid-template-columns: 1fr;
        }

        .control-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>

<script>
    // Load and display statistics
    function loadStats() {
        fetch('/api/database-stats')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    // Update main stats
                    document.getElementById('db-size').textContent = data.database_size_mb + ' MB';
                    document.getElementById('orders-count').textContent = data.orders_count.toLocaleString();
                    document.getElementById('payments-count').textContent = data.payments_count.toLocaleString();

                    // Calculate data range
                    if (data.oldest_order && data.oldest_order !== 'N/A') {
                        const oldest = new Date(data.oldest_order).toLocaleDateString();
                        const newest = new Date(data.newest_order).toLocaleDateString();
                        document.getElementById('data-range').textContent = oldest + ' to ' + newest;
                        document.getElementById('detail-oldest').textContent = oldest;
                        document.getElementById('detail-newest').textContent = newest;
                    }

                    // Update detailed info
                    document.getElementById('detail-db-size').textContent = data.database_size_mb + ' MB';
                    
                    const usagePercent = ((data.database_size_mb / 10000) * 100).toFixed(1);
                    document.getElementById('detail-usage-percent').textContent = usagePercent + '%';
                    
                    // Set status
                    const statusElement = document.getElementById('detail-usage-status');
                    if (data.database_size_mb < 6480) {
                        statusElement.textContent = '‚úÖ Within limit';
                        statusElement.style.color = '#27ae60';
                    } else {
                        statusElement.textContent = '‚ö†Ô∏è Check usage';
                        statusElement.style.color = '#f39c12';
                    }
                }
            })
            .catch(error => console.error('Error loading stats:', error));
    }

    // Trigger manual cleanup
    function triggerCleanup() {
        if (!confirm('Delete data older than 90 days? This action cannot be undone.')) {
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Processing...';

        fetch('/api/cleanup-old-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ days: 90 })
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('cleanup-result');
            
            if (data.success) {
                resultDiv.className = 'cleanup-result success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ Cleanup Successful!</strong><br>
                    Orders deleted: ${data.details.orders_deleted}<br>
                    Payments deleted: ${data.details.payments_deleted}<br>
                    Cutoff date: ${new Date(data.details.cutoff_date).toLocaleDateString()}
                `;
                setTimeout(loadStats, 1000);
            } else {
                resultDiv.className = 'cleanup-result error';
                resultDiv.innerHTML = `<strong>‚úó Error:</strong> ${data.message}`;
            }
            
            resultDiv.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'üßπ Clean Old Data Now';
        })
        .catch(error => {
            const resultDiv = document.getElementById('cleanup-result');
            resultDiv.className = 'cleanup-result error';
            resultDiv.innerHTML = '<strong>‚úó Error:</strong> ' + error.message;
            resultDiv.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'üßπ Clean Old Data Now';
        });
    }

    // Refresh statistics
    function refreshStats() {
        loadStats();
        alert('Statistics refreshed!');
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        // Refresh every 5 minutes
        setInterval(loadStats, 300000);
    });
</script>
{% endblock %}
